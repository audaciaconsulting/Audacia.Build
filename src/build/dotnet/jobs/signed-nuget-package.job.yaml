# Job to build a NuGet Package that will be hosted on the Audacia NuGet feed, as this requires code signing
parameters:
  - name: displayName
    default: 'Build Package'
  - name: projects
    default: '**/*.csproj'
  - name: configuration
    default: 'release'
  - name: testPath
    default: '**/*Tests/*.csproj'
  - name: skipDependencyChecks
    default: true
  - name: workingDirectory # The working directory containing relevant csproj and nuspec files; if not set then $(Build.SourcesDirectory) is used.
    default: ''
  - name: packageSource # Where the package is published; should be one of 'public', 'internalPrivate' or 'internalPublic'
    default: 'public'
  - name: excludePaths # Comma-delimited paths to exclude from versioning
    default: '*.Tests.csproj'
  - name: artifactName
    default: '$(Build.DefinitionName)'
  - name: runTests
    default: true
  - name: applyVersioning
    default: true
  - name: trustedSigningEndpoint
    type: string
  - name: trustedSigningAccount
    type: string
  - name: trustedSigningCertificateProfile
    type: string
  - name: directory
    type: string
  - name: fileToSignPattern
    type: string
  - name: serviceConnection
    type: string

jobs:
  - job: Job_Build
    # Code signing using Trusted Signing only works on Windows
    pool:
      vmImage: windows-latest
    displayName: ${{parameters.displayName}}
    
    steps:
      - ${{ if eq(parameters.skipDependencyChecks, false) }}:
        - template: /src/security/dependency-check/steps/nuget-dependency-check.steps.yaml
          parameters:
            continueIfVulnerabilities: true

      - ${{ if eq(parameters.applyVersioning, true) }}:
        - task: UpdateVersions@1
          name: UpdateVersions
          displayName: .NET Versioning
          inputs:
            buildType: 'nuget'
            workingDirectory: ${{parameters.workingDirectory}}
            packageSource: ${{parameters.packageSource}}
            excludePaths: ${{parameters.excludePaths}}
          env:
            SYSTEM_ACCESSTOKEN: $(System.AccessToken)

      - task: DotNetCoreCLI@2
        displayName: .NET Restore
        inputs:
          command: restore
          projects: ${{parameters.projects}}

      - task: DownloadSecureFile@1
        displayName: Get Strong Naming Certificate
        name: StrongNameCertificate
        inputs:
          secureFile: audacia.snk

      - task: MSBuild@1
        displayName: .NET Build
        inputs:
          solution: ${{parameters.projects}}
          msbuildArchitecture: x64
          configuration: ${{parameters.configuration}}
          msbuildArguments: /p:AssemblyOriginatorKeyFile=$(StrongNameCertificate.secureFilePath)

      - task: DotNetCoreCLI@2
        displayName: .NET Test
        condition: and(succeeded(), eq('${{parameters.runTests}}', true))
        inputs:
          command: test
          projects: ${{parameters.testPath}}
          arguments: >
            --collect "Code coverage"
          configuration: 'Release'

      - template: /src/build/dotnet/tasks/netcore/assembly-sign.yaml
        parameters:
          trustedSigningEndpoint: ${{ parameters. trustedSigningEndpoint }}
          trustedSigningAccount: ${{ parameters.trustedSigningAccount }}
          trustedSigningCertificateProfile: ${{ parameters.trustedSigningCertificateProfile }}
          directory: ${{ parameters.directory }}
          fileToSignPattern: ${{ parameters.fileToSignPattern }}
          serviceConnection: ${{ parameters.serviceConnection }}

      - task: DotNetCoreCLI@2
        displayName: .NET Pack
        inputs:
          command: pack
          nobuild: true
          includesymbols: false
          packagesToPack: ${{parameters.projects}}

      - task: AzureCLI@2
        displayName: NuGet Sign
        inputs:
          azureSubscription: ${{ parameters.serviceConnection }}
          scriptLocation: inlineScript
          scriptType: ps
          inlineScript: |
            Write-Host "Installing signing tools"
            dotnet tool install Knapcode.CertificateExtractor --global
            dotnet tool install sign --global --prerelease

            Write-Host "Getting packages to sign"
            $packagesToSign = Get-ChildItem -Path "$env:PIPELINE_WORKSPACE" -Filter "*.nupkg" -Recurse
            foreach ($package in $packagesToSign) {
                Write-Host "Signing package $package"
                $path = $package.FullName
                sign code trusted-signing "$path" -act azure-cli -tse "${{ parameters.trustedSigningEndpoint }}" -tsa "${{ parameters.trustedSigningAccount }}" -tscp "${{ parameters.trustedSigningCertificateProfile }}"
            }
            # All packages will be signed with the same certificate, so only need to extract one
            Write-Host "Extracting package signing certificate"
            nuget-cert-extractor --file "$path" --output "$env:BUILD_ARTIFACTSTAGINGDIRECTORY\signing-certificate" --code-signing --author --leaf

      - task: PublishPipelineArtifact@1
        inputs:
          targetPath: $(Build.ArtifactStagingDirectory)/signing-certificate
          artifactName: PackageSigningCertificate

      - template: /src/build/common/tasks/publish.yaml
        parameters:
          path: ''
          artifactName: ${{parameters.artifactName}}