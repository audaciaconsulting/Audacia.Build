# Task to sign a .NET Core Project with the Audacia Code Signing certificate
parameters:
  - name: trustedSigningEndpoint
    type: string
  - name: trustedSigningAccount
    type: string
  - name: trustedSigningCertificateProfile
    type: string
  - name: directory
    type: string
  - name: fileToSignPattern
    type: string
  - name: serviceConnection
    type: string

steps:
  - task: AzureCLI@2
    displayName: 'Add Service Connection to Environment'
    inputs:
      azureSubscription: '${{ parameters.serviceConnection }}'
      scriptType: 'ps'
      scriptLocation: 'inlineScript'
      inlineScript: |
        echo "##vso[task.setvariable variable=ARM_CLIENT_ID;issecret=true]$servicePrincipalId" 
        echo "##vso[task.setvariable variable=ARM_ID_TOKEN;issecret=true]$idToken"
        echo "##vso[task.setvariable variable=ARM_TENANT_ID;issecret=true]$tenantId"
      addSpnToEnvironment: true

  - bash: |
      az login --service-principal -u $(ARM_CLIENT_ID) --tenant $(ARM_TENANT_ID) --allow-no-subscriptions --federated-token $(ARM_ID_TOKEN)
    displayName: 'Azure Login'

  - task: TrustedSigning@0
    displayName: 'Sign with Trusted Signing'
    inputs:
      Endpoint: '${{ parameters.trustedSigningEndpoint }}'
      TrustedSigningAccountName: '${{ parameters.trustedSigningAccount }}'
      CertificateProfileName: '${{ parameters.trustedSigningCertificateProfile }}'
      FilesFolder: '${{ parameters.directory }}'
      FilesFolderFilter: '${{ parameters.fileToSignPattern }}'
      FilesFolderRecurse: true
      FileDigest: 'SHA256'
      TimestampRfc3161: 'http://timestamp.acs.microsoft.com'
      TimestampDigest: 'SHA256'
      ExcludeEnvironmentCredential: true
      ExcludeWorkloadIdentityCredential: true
      ExcludeManagedIdentityCredential: true
      ExcludeSharedTokenCacheCredential: true
      ExcludeVisualStudioCredential: true
      ExcludeVisualStudioCodeCredential: true
      ExcludeAzureCliCredential: false
      ExcludeAzurePowershellCredential: true
      ExcludeAzureDeveloperCliCredential: true
      ExcludeInteractiveBrowserCredential: true