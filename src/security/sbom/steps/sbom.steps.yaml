# sbom.steps.yaml
parameters:
  - name: sbomOutputDir
    type: string
    default: '$(Agent.TempDirectory)/sbom'           # Directory to store generated SBOM files.
  - name: lockDepsArtifactDir
    type: string
    default: ''                                       # Path containing the published lock/deps artifact.
  - name: outputFormat
    type: string
    default: 'cyclonedx-json'                         # SBOM output format.
  - name: vulnFolder
    type: string
    default: '$(Agent.TempDirectory)/vuln'            # Directory to store vulnerability reports.
  - name: analysisOutputFormat
    type: string
    default: 'cyclonedx-json'                         # Output format for vulnerability analysis.
  - name: downloadArtifact
    type: boolean
    default: false                                  # Flag to indicate if the SBOM artifact should be downloaded before analysis.
  - name: publishGenerationArtifact
    type: boolean
    default: true                                   # Flag to control publishing of the SBOM generation artifact.
  - name: sbomArtifactName
    type: string
    default: 'sbom-files'                           # Artifact name for the generated SBOM files.
  - name: syftInstallDir
    type: string
    default: '$(Agent.TempDirectory)'               # Directory for installing Syft.
  - name: grypeInstallDir
    type: string
    default: '$(Agent.TempDirectory)'               # Directory for installing Grype.

steps:
  - template: sbom-generation.yaml@templates
    parameters:
      sbomOutputDir: ${{ parameters.sbomOutputDir }}
      lockDepsArtifactDir: ${{ parameters.lockDepsArtifactDir }}
      outputFormat: ${{ parameters.outputFormat }}
      publishArtifact: ${{ parameters.publishGenerationArtifact }}
      artifactName: ${{ parameters.sbomArtifactName }}
      syftInstallDir: ${{ parameters.syftInstallDir }}

  - template: sbom-analysis.yaml@templates
    parameters:
      sbomDir: ${{ parameters.sbomOutputDir }}
      analysisOutputFormat: ${{ parameters.analysisOutputFormat }}
      vulnFolder: ${{ parameters.vulnFolder }}
      downloadArtifact: ${{ parameters.downloadArtifact }}
      sbomArtifactName: ${{ parameters.sbomArtifactName }}
      grypeInstallDir: ${{ parameters.grypeInstallDir }}
