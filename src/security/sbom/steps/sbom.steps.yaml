# sbom.steps.yaml
parameters:
  - name: sbomOutputDir
    type: string
    default: '$(Agent.TempDirectory)/sbom'
  - name: npmScanDir
    type: string
    default: ''             # Supply a valid path for npm projects or leave empty.
  - name: dotnetScanDir
    type: string
    default: ''             # Supply a valid path for .NET projects or leave empty.
  - name: outputFormat
    type: string
    default: 'cyclonedx-json'
  - name: vulnFolder
    type: string
    default: '$(Agent.TempDirectory)/vuln'
  - name: analysisOutputFormat
    type: string
    default: 'cyclonedx-json'
  - name: downloadArtifact
    type: boolean
    default: false
  - name: publishGenerationArtifact
    type: boolean
    default: true
  # Use a single parameter for the SBOM artifact name.
  - name: sbomArtifactName
    type: string
    default: 'sbom-files'
  - name: syftInstallDir
    type: string
    default: '$(Agent.TempDirectory)'
  - name: grypeInstallDir
    type: string
    default: '$(Agent.TempDirectory)'
  - name: analyzeNpm
    type: boolean
    default: true
  - name: analyzeDotnet
    type: boolean
    default: true

steps:
  - template: sbom-generation.yaml@templates
    parameters:
      sbomOutputDir: ${{ parameters.sbomOutputDir }}
      npmScanDir: ${{ parameters.npmScanDir }}
      dotnetScanDir: ${{ parameters.dotnetScanDir }}
      outputFormat: ${{ parameters.outputFormat }}
      publishArtifact: ${{ parameters.publishGenerationArtifact }}
      artifactName: ${{ parameters.sbomArtifactName }}
      syftInstallDir: ${{ parameters.syftInstallDir }}

  - template: sbom-analysis.yaml@templates
    parameters:
      sbomDir: ${{ parameters.sbomOutputDir }}
      analyzeNpm: ${{ parameters.analyzeNpm }}
      analyzeDotnet: ${{ parameters.analyzeDotnet }}
      analysisOutputFormat: ${{ parameters.analysisOutputFormat }}
      vulnFolder: ${{ parameters.vulnFolder }}
      downloadArtifact: ${{ parameters.downloadArtifact }}
      sbomArtifactName: ${{ parameters.sbomArtifactName }}
      grypeInstallDir: ${{ parameters.grypeInstallDir }}
