# sbom-generation.yaml
parameters:
  - name: sbomOutputDir
    type: string
    default: '$(Agent.TempDirectory)/sbom'        # Local folder to store the generated SBOM files.
  - name: npmScanDir
    type: string
    default: ''                                    # Path to scan for npm dependencies. Leave empty if not applicable.
  - name: dotnetScanDir
    type: string
    default: ''                                    # Path to scan for .NET dependencies. Leave empty if not applicable.
  - name: outputFormat
    type: string
    default: 'cyclonedx-json'                      # SBOM output format. Change as needed.
  - name: publishArtifact
    type: boolean
    default: true                                 # Publish the generated SBOM as a pipeline artifact.
  - name: artifactName
    type: string
    default: 'sbom-files'                          # Artifact name for the generated SBOM.
  - name: syftInstallDir
    type: string
    default: '$(Agent.TempDirectory)'             # Directory where Syft will be installed.

steps:
  - script: |
      echo "Creating SBOM folder at: ${{ parameters.sbomOutputDir }}"
      mkdir "${{ parameters.sbomOutputDir }}"
    displayName: 'Create SBOM folder'

  - script: |
      echo "Installing Syft (SBOM Generator) into ${{ parameters.syftInstallDir }}"
      curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b "${{ parameters.syftInstallDir }}"
    displayName: 'Install Syft (SBOM Generator)'
  
  # Generate SBOM for npm if npmScanDir is provided.
  - ${{ if ne(parameters.npmScanDir, '') }}:
      - script: |
          echo "Generating NPM SBOM from directory: ${{ parameters.npmScanDir }}"
          "${{ parameters.syftInstallDir }}/syft.exe" -o ${{ parameters.outputFormat }}="${{ parameters.sbomOutputDir }}/sbom-npm-file.json" "${{ parameters.npmScanDir }}"
        displayName: 'Generate NPM SBOM'
  
  # Generate SBOM for .NET if dotnetScanDir is provided.
  - ${{ if ne(parameters.dotnetScanDir, '') }}:
      - script: |
          echo "Generating .NET SBOM from directory: ${{ parameters.dotnetScanDir }}"
          "${{ parameters.syftInstallDir }}/syft.exe" -o ${{ parameters.outputFormat }}="${{ parameters.sbomOutputDir }}/sbom-dotnet-file.json" "${{ parameters.dotnetScanDir }}"
        displayName: 'Generate .NET SBOM'

  - ${{ if eq(parameters.publishArtifact, true) }}:
      - task: PublishPipelineArtifact@1
        displayName: 'Publish SBOM Artifact'
        inputs:
          targetPath: ${{ parameters.sbomOutputDir }}
          publishLocation: 'pipeline'
          artifact: ${{ parameters.artifactName }}
