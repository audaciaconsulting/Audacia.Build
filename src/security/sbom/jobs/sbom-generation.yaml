parameters:
  # Indicates whether to generate an SBOM for NPM dependencies.
  - name: runNpm
    type: boolean
    default: true

  # Indicates whether to generate an SBOM for .NET dependencies.
  - name: runDotnet
    type: boolean
    default: true

  # The output format for the NPM SBOM.
  - name: npmSbomOutputFormat
    type: string
    default: 'cyclonedx-json'

  # The output format for the .NET SBOM.
  - name: dotnetSbomOutputFormat
    type: string
    default: 'cyclonedx-json'

  # Directory where NPM dependencies are located and should be scanned.
  - name: npmScanDirectory
    type: string
    default: '$(System.DefaultWorkingDirectory)/src/apps'

  # Directory where .NET dependencies are located and should be scanned.
  - name: dotnetScanDirectory
    type: string
    default: '$(Pipeline.Workspace)/$(Build.DefinitionName)'

  # Local folder to store the generated SBOM files.
  - name: outputFolder
    type: string
    default: '$(Agent.TempDirectory)\sbom'

  # The name of the published artifact that contains the SBOM files.
  - name: artifactName
    type: string
    default: 'sbom-files'

  # URL for the Syft installation script used to generate SBOMs.
  - name: syftInstallUrl
    type: string
    default: 'https://raw.githubusercontent.com/anchore/syft/main/install.sh'

jobs:
  - job: GenerateSBOM
    displayName: 'Generate SBOM'
    steps:
      - download: current
        displayName: 'Download Source Code'

      - script: mkdir "${{ parameters.outputFolder }}"
        displayName: 'Create SBOM Folder'

      - script: |
          curl -sSfL ${{ parameters.syftInstallUrl }} | sh -s -- -b $(Agent.TempDirectory)
        displayName: 'Install Syft (SBOM Generator)'
      
      # Generate the NPM SBOM if enabled.
      - ${{ if eq(parameters.runNpm, true) }}:
          - script: |
              "$(Agent.TempDirectory)\syft.exe" -o ${{ parameters.npmSbomOutputFormat }}="${{ parameters.outputFolder }}\sbom-npm-file.json" "${{ parameters.npmScanDirectory }}"
            displayName: 'Generate NPM SBOM'
      
      # Generate the .NET SBOM if enabled.
      - ${{ if eq(parameters.runDotnet, true) }}:
          - script: |
              "$(Agent.TempDirectory)\syft.exe" -o ${{ parameters.dotnetSbomOutputFormat }}="${{ parameters.outputFolder }}\sbom-dotnet-file.json" "${{ parameters.dotnetScanDirectory }}"
            displayName: 'Generate .NET SBOM'

      - task: PublishPipelineArtifact@1
        displayName: 'Publish SBOM Output'
        inputs:
          targetPath: ${{ parameters.outputFolder }}
          publishLocation: 'pipeline'
          artifact: ${{ parameters.artifactName }}
