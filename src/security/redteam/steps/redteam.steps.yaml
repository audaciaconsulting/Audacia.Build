parameters:
  # Path to your redteam.yaml config file
  - name: configPath
    type: string
    default: ''

  # Optional path to your npm working directory
  - name: npmWorkingDirectory
    type: string
    default: ''

  # Should publish HTML result artifact?
  - name: publishHtml
    type: boolean
    default: true

  # Should publish Json result artifact?
  - name: publishJson
    type: boolean
    default: true

  # LLM Api Url
  - name: apiUrl
    type: string
    default: ''

  # Auth token URL
  - name: authTokenUrl
    type: string
    default: ''

  # Auth client id
  - name: authClientId
    type: string
    default: ''

  # Auth client secret
  - name: authClientSecret
    type: string
    default: ''

  # Auth client scope
  - name: authClientScope
    type: string
    default: ''

  # Chosen LLM Model
  - name: chosenModel
    type: string
    default: '100'

steps:
  - checkout: self
    clean: true

  - checkout: templates
    clean: true
    path: s/templates

  # Node for Promptfoo
  - task: NodeTool@0
    displayName: 'Install Node.js 20'
    inputs:
      versionSpec: '20.x'

  # npm install
  - script: |
      set -euo pipefail

      ROOT="$(System.DefaultWorkingDirectory)"
      echo "Repo root: ${ROOT}"

      # Resolve ABS_NPM_DIR:
      # 1) If npmWorkingDirectory provided and absolute, use it
      # 2) If npmWorkingDirectory provided and relative, resolve under ROOT
      # 3) Else fallback to the directory that contains configPath
      RAW_DIR='${{ parameters.npmWorkingDirectory }}'
      if [ -n "$RAW_DIR" ]; then
        if [[ "$RAW_DIR" = /* ]]; then
          ABS_NPM_DIR="$RAW_DIR"
        else
          ABS_NPM_DIR="${ROOT}/$RAW_DIR"
        fi
      else
        ABS_NPM_DIR="${ROOT}/$(dirname '${{ parameters.configPath }}')"
      fi

      echo "Resolved npm working directory: ${ABS_NPM_DIR}"

      # Try npm ci only if the folder exists AND contains a package manifest
      if [ -d "${ABS_NPM_DIR}" ]; then
        if [ -f "${ABS_NPM_DIR}/package-lock.json" ] || [ -f "${ABS_NPM_DIR}/package.json" ]; then
          echo "Running npm ci in ${ABS_NPM_DIR}"
          cd "${ABS_NPM_DIR}"
          npm ci || npm install
        else
          echo "WARNING: No package.json or package-lock.json in ${ABS_NPM_DIR} — skipping npm ci"
        fi
      else
        echo "WARNING: npm working directory not found: ${ABS_NPM_DIR} — skipping npm ci"
        echo "Top-level tree under ${ROOT}:"
        ls -la "${ROOT}" || true
        echo "Repo tree (first 2 levels) to aid debugging:"
        find "${ROOT}" -maxdepth 2 -type d -print | sort
      fi

      # Always install promptfoo globally so the red team run can proceed
      npm install -g promptfoo
      promptfoo --version
    displayName: 'Install dependencies and Promptfoo'

  # Python for target script resolution
  - task: UsePythonVersion@0
    displayName: 'Use Python 3.12'
    inputs:
      versionSpec: '3.12'
      addToPath: true

  - script: |
      set -euo pipefail
      python --version
      python -m pip install --upgrade pip
      python -m pip install oauthlib pydantic python-dotenv requests requests-oauthlib
    displayName: 'Install Python dependencies'

  # Run Promptfoo Red Team
  - script: |
      set -euo pipefail
      RESULTS_DIR="$(System.DefaultWorkingDirectory)/results"
      mkdir -p "$RESULTS_DIR"

      CONFIG_PATH="$(System.DefaultWorkingDirectory)/${{ parameters.configPath }}"
      CONFIG_DIR="$(dirname "$CONFIG_PATH")"
      CONFIG_FILE="$(basename "$CONFIG_PATH")"

      echo "Running Promptfoo red team:"
      echo "  Config dir:  $CONFIG_DIR"
      echo "  Config file: $CONFIG_FILE"
      echo "  Results dir: $RESULTS_DIR"

      pushd "$CONFIG_DIR" >/dev/null

      npx promptfoo redteam eval \
        --config "$CONFIG_FILE" \
        --output "$RESULTS_DIR/results.json" \
        --output "$RESULTS_DIR/report.html"

      popd >/dev/null
    displayName: 'Run Promptfoo Red Team'
    env:
      PYTHONPATH: $(System.DefaultWorkingDirectory)
      API_URL: ${{ parameters.apiUrl }}
      AUTH_TOKEN_URL: ${{ parameters.authTokenUrl }}
      AUTH_CLIENT_ID: ${{ parameters.authClientId }}
      AUTH_CLIENT_SECRET: ${{ parameters.authClientSecret }}
      AUTH_CLIENT_SCOPE: ${{ parameters.authClientScope }}
      CHOSEN_MODEL: ${{ parameters.chosenModel }}

  # Convert JSON to JUnit
  - script: |
      set -euo pipefail
      RESULTS_DIR="$(System.DefaultWorkingDirectory)/results"
      JUNIT_ABS="$RESULTS_DIR/results.junit.xml"
      CONVERTER="$(System.DefaultWorkingDirectory)/templates/src/security/redteam/scripts/promptfoo-to-junit.js"
      node --version
      node "$CONVERTER" "$RESULTS_DIR/results.json" "$JUNIT_ABS"

      echo "Verifying:"
      ls -la "$RESULTS_DIR" || true
      head -n 2 "$JUNIT_ABS" || true
    displayName: 'Convert Promptfoo results to JUnit XML'
    condition: succeededOrFailed()

  # Publish JUnit to Tests tab
  - task: PublishTestResults@2
    displayName: 'Publish Test Results (JUnit)'
    inputs:
      testResultsFormat: 'JUnit'
      testResultsFiles: 'results/results.junit.xml'
      searchFolder: '$(System.DefaultWorkingDirectory)'
      mergeTestResults: true
      testRunTitle: 'Promptfoo Red Team'
      failTaskOnMissingResults: true
    condition: succeededOrFailed()

  # Optional: publish JSON/HTML artifacts
  - ${{ if eq(parameters.publishJson, true) }}:
      - task: PublishBuildArtifacts@1
        inputs:
          pathtoPublish: '$(System.DefaultWorkingDirectory)/results/results.json'
          artifactName: 'promptfoo-redteam-results'
        condition: succeededOrFailed()
        displayName: 'Publish Red Team Results (JSON)'

  - ${{ if eq(parameters.publishHtml, true) }}:
      - task: PublishBuildArtifacts@1
        inputs:
          pathtoPublish: '$(System.DefaultWorkingDirectory)/results/report.html'
          artifactName: 'promptfoo-redteam-results'
        condition: succeededOrFailed()
        displayName: 'Publish Red Team Results (HTML)'
