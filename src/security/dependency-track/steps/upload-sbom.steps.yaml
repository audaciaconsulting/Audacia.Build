# Template: download SBOM artifact and upload via Dependency-Track API.
parameters:
  # Name of the artifact to download (produced by generate-sbom template).
  - name: artifactName
    type: string
    default: 'sbom-files'

  # If true: fail the job when any upload fails.
  # Recommendation: true in mainline; false in exploratory/dry-run scenarios.
  - name: failOnUploadError
    type: boolean
    default: true
  - name: requireProjectTags
    type: boolean
    default: true
  - name: enableRollback
    type: boolean
    default: true
  - name: validationOnly
    type: boolean
    default: false
  # New: pass-through wait for BOM processing (seconds)
  - name: bomProcessingTimeoutSec
    type: number
    default: 300

steps:
  # Download SBOM artifact
  - template: /src/security/dependency-track/steps/upload/download-sbom-artifact.step.yaml@templates
    parameters:
      artifactName: ${{ parameters.artifactName }}

  # Build project tags from environment variables
  - template: /src/security/dependency-track/steps/upload/build-project-tags.step.yaml@templates
    parameters:
      requireProjectTags: ${{ parameters.requireProjectTags }}

  # Discover SBOM files and create JSON array
  - template: /src/security/dependency-track/steps/upload/discover-sbom-files.step.yaml@templates

  # Upload SBOMs to Dependency-Track
  - template: /src/security/dependency-track/steps/upload/upload-sboms.step.yaml@templates
    parameters:
      failOnUploadError: ${{ parameters.failOnUploadError }}
      enableRollback: ${{ parameters.enableRollback }}
      validationOnly: ${{ parameters.validationOnly }}
      bomProcessingTimeoutSec: ${{ parameters.bomProcessingTimeoutSec }}
