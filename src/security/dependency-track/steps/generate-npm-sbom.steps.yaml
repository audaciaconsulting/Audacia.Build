## Template: generate npm SBOMs using cyclonedx-npm

parameters:
  # One or more directories that contain a package.json. Accepts a single string or a multiline string.
  # Paths may be repo-relative or absolute. Mixed separators are normalized and each entry is validated.
  - name: npmRoots
    type: string
    default: ''

  # Node.js version spec understood by UseNode (e.g., "22.x"). The major version is resolved on the hosted agent.
  - name: nodeVersion
    type: string
    default: '22.x'

  # When true, runs a clean installation and gathers license texts. Produces richer SBOMs at the cost of time and artifact size.
  - name: includeLicenseTexts
    type: boolean
    default: true

  # Publish the SBOM output from this step. Set false when combining with .NET to publish once later.
  - name: publishArtifact
    type: boolean
    default: false

  # Logical name for the pipeline artifact when publishing is enabled.
  - name: artifactName
    type: string
    default: 'sbom-files'

  # Optional: Zero or more .npmrc paths as an array. Each will be authenticated separately.
  # Uses a string array (not multiline string) so we can loop through actual .npmrc paths without fixed line limits.
  - name: npmrcPaths
    type: object
    default: []

steps:
  - task: UseNode@1
    displayName: Use Node.js ${{ parameters.nodeVersion }}
    inputs:
      versionSpec: ${{ parameters.nodeVersion }}
      checkLatest: false

  - ${{ if eq(length(parameters.npmrcPaths), 0) }}:
      - script: echo "No npmrcPaths provided — skipping npm authentication."
        displayName: "Skip npm authentication"

  - ${{ each npmrcPath in parameters.npmrcPaths }}:
      - task: npmAuthenticate@0
        displayName: "Authenticate npm via .npmrc → ${{ npmrcPath }}"
        inputs:
          workingFile: ${{ npmrcPath }}

  # UseNode@1 already sets up PATH; no extra tooling exposure needed.

  - task: PowerShell@2
    name: resolveNpmRoots
    displayName: "Validate npm project roots"
    inputs:
      pwsh: true
      targetType: inline
      script: |
        $ErrorActionPreference = 'Stop'
        $raw = @'
        ${{ parameters.npmRoots }}
        '@
        $lines = $raw -split "`n" | ForEach-Object { $_.Trim() } | Where-Object { $_ }
        if ($lines.Count -eq 0) { throw "No npm roots supplied (npmRoots parameter)." }

        $root = $env:BUILD_SOURCESDIRECTORY
        if (-not $root) { $root = $env:SYSTEM_DEFAULTWORKINGDIRECTORY }
        $root = [IO.Path]::GetFullPath($root)

        $validated = New-Object System.Collections.Generic.List[string]
        foreach ($p in $lines) {
          $candidate = $p
          if (-not [IO.Path]::IsPathRooted($candidate)) { $candidate = Join-Path $root $candidate }
          $pkg = Join-Path $candidate 'package.json'
          if (-not (Test-Path -LiteralPath $pkg)) { throw "package.json not found at: $pkg" }
          if (-not ($validated -contains $candidate)) { $validated.Add($candidate) }
        }

        # Log validated absolute roots
        $validated | ForEach-Object { Write-Host $_ }

        $multiline = ($validated -join "`n")
        $json = ($validated | ConvertTo-Json -Compress -AsArray)
        Write-Host "##vso[task.setvariable variable=npmRootsMultiline;isOutput=true]$multiline"
        Write-Host "##vso[task.setvariable variable=npmRootsJson;isOutput=true]$json"

  - task: PowerShell@2
    displayName: "Generate npm SBOMs (CycloneDX, JSON)"
    inputs:
      pwsh: true
      targetType: inline
      script: |
        $ErrorActionPreference = 'Stop'
        New-Item -ItemType Directory -Path "$(Agent.TempDirectory)/sbom" -Force | Out-Null
        New-Item -ItemType Directory -Path "$(Agent.TempDirectory)/sbom/npm" -Force | Out-Null

        npm config set cache "$(Pipeline.Workspace)/.npm" --global | Out-Null

        # Prefer JSON list; fallback to multiline
        $roots = @()
        $rootsJson = '$(resolveNpmRoots.npmRootsJson)'
        if ($rootsJson -and $rootsJson.Trim().Length -gt 0) { try { $roots = @($rootsJson | ConvertFrom-Json) } catch { $roots = @() } }
        if (-not $roots -or $roots.Count -eq 0) {
          $rootsMultiline = '$(resolveNpmRoots.npmRootsMultiline)'
          if ($rootsMultiline) { $roots = $rootsMultiline -split "`n" | ForEach-Object { $_.Trim() } | Where-Object { $_ } }
        }
        if ($roots.Count -eq 0) { throw "No npm roots resolved for generation." }

        Write-Host ("npm projects to generate SBOMs for: {0}" -f $roots.Count)
        foreach ($r in $roots) { Write-Host (" - {0}" -f $r) }

        $includeLicenseTexts = "${{ parameters.includeLicenseTexts }}" -eq "True"
        $successCount = 0
        $failureCount = 0

        function Get-OutputBaseName([string]$absoluteProjectPath) {
          $leaf = Split-Path $absoluteProjectPath -Leaf
          if ([string]::IsNullOrWhiteSpace($leaf)) { $leaf = 'app' }
          $parent = Split-Path (Split-Path $absoluteProjectPath -Parent) -Leaf
          if ([string]::IsNullOrWhiteSpace($parent)) { $parent = 'root' }
          return ("$parent-$leaf" -replace '[<>:"/\\|?*]', '-')
        }

        foreach ($projectRoot in $roots) {
          $absoluteProjectPath = if ([System.IO.Path]::IsPathRooted($projectRoot)) { $projectRoot } else { Join-Path $env:BUILD_SOURCESDIRECTORY $projectRoot }
          $packageJsonPath  = Join-Path $absoluteProjectPath 'package.json'
          $packageLockPath = Join-Path $absoluteProjectPath 'package-lock.json'
          if (-not (Test-Path -LiteralPath $packageJsonPath)) { throw "package.json is required but was not found at: $packageJsonPath" }

          $outputFolderName = Get-OutputBaseName -absoluteProjectPath $absoluteProjectPath
          $outputDir = Join-Path "$(Agent.TempDirectory)/sbom/npm" $outputFolderName
          New-Item -ItemType Directory -Path $outputDir -Force | Out-Null
          $outputFile = Join-Path $outputDir "$outputFolderName-sbom.json"

          Write-Host ("Generating npm SBOM for: {0}" -f $absoluteProjectPath)
          Push-Location $absoluteProjectPath
          try {
            $hasPackageLock = Test-Path -LiteralPath $packageLockPath
            if (-not $hasPackageLock) {
              npm install --package-lock-only --ignore-scripts --no-audit --no-fund
              $hasPackageLock = Test-Path -LiteralPath $packageLockPath
              if (-not $hasPackageLock) { throw "Failed to create package-lock.json in '$absoluteProjectPath'" }
            }

            $args = @('--output-format','json','--output-file',$outputFile)
            if ($includeLicenseTexts) { $args += @('--gather-license-texts'); npm ci --ignore-scripts --no-audit --no-fund --no-progress }
            if (-not $includeLicenseTexts -and $hasPackageLock) { $args += @('--package-lock-only') }

            # Use direct package execution to avoid Windows PATH shim issues
            npx --y @cyclonedx/cyclonedx-npm@4 -- @args
            if ($LASTEXITCODE -ne 0) { throw "cyclonedx-npm failed (exit $LASTEXITCODE)" }

            if (Test-Path $outputFile) { $successCount++ } else { $failureCount++; Write-Warning "Missing expected output: $outputFile" }
          } catch {
            Write-Warning "npm SBOM failed for '$absoluteProjectPath': $($_.Exception.Message)"; $failureCount++
          } finally {
            Pop-Location | Out-Null
            Write-Host "Output: $outputFile"
          }
        }

        Write-Host "##[section]npm summary → ok=$successCount, failed=$failureCount"
        if ($failureCount -gt 0) { Write-Host "##vso[task.logissue type=warning]Some JS SBOMs failed"; exit 1 }

  - ${{ if eq(parameters.publishArtifact, true) }}:
      - task: PublishPipelineArtifact@1
        displayName: "Publish SBOM artifact"
        inputs:
          targetPath: "$(Agent.TempDirectory)/sbom"
          publishLocation: pipeline
          artifact: ${{ parameters.artifactName }}
