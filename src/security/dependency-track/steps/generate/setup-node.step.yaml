# Template: setup Node.js and expose tooling paths
parameters:
  # Parameter: nodeVersion
  # - Specifies the version of Node.js to use (e.g., "20.x")
  - name: nodeVersion
    type: string

steps:
  # Step: Use Node.js
  # - Configures the specified version of Node.js for the pipeline
  - task: UseNode@1
    displayName: Use Node.js ${{ parameters.nodeVersion }}
    inputs:
      versionSpec: ${{ parameters.nodeVersion }}
      checkLatest: false

  # Step: Setup Node.js tooling and expose paths
  # - Resolves the paths for Node.js, npm, and npx executables
  # - Adds the resolved paths to the system PATH
  # - Exposes the resolved paths as pipeline variables for subsequent steps
  - powershell: |
      # Stop execution on errors
      $ErrorActionPreference = 'Stop'

      if (-not '${{ parameters.nodeVersion }}' -or [string]::IsNullOrWhiteSpace('${{ parameters.nodeVersion }}')) {
        throw "setup-node.step.yaml: 'nodeVersion' was not provided. Pass a spec such as '20.x'"
      }

      # Function: Get-NodeToolPaths
      # - Resolves the paths for Node.js tooling based on the major version
      # - Throws an error if the required tools are not found
      function Get-NodeToolPaths {
        param([string]$major)
        $root = Join-Path $env:AGENT_TOOLSDIRECTORY 'node'
        if (-not (Test-Path $root)) { throw "Node tools directory not found: $root" }
        $ver = Get-ChildItem $root -Directory -Name | Where-Object { $_ -like "$major.*" } | Sort-Object { [version]$_ } -Descending | Select-Object -First 1
        if (-not $ver) { throw "No Node $major.* found under $root" }
        $bin = Join-Path (Join-Path $root $ver) 'x64'
        $node = Join-Path $bin 'node.exe'
        $npm  = Join-Path $bin 'npm.cmd'
        $npx  = Join-Path $bin 'npx.cmd'
        if (-not (Test-Path $node)) { throw "node.exe not found at $node" }
        if (-not (Test-Path $npm))  { throw "npm.cmd not found at $npm" }
        if (-not (Test-Path $npx))  { throw "npx.cmd not found at $npx" }
        [pscustomobject]@{ Node=$node; Npm=$npm; Npx=$npx; Bin=$bin; Version=$ver }
      }

      # Derive major from the provided version spec (e.g., "20.x" â†’ "20")
      $spec  = '${{ parameters.nodeVersion }}'
      $major = [regex]::Match($spec, '^\d+').Value
      if (-not $major) { throw "Could not derive Node major version from spec: '$spec'." }

      # Resolve Node.js tooling paths for the specified major version
      $tool = Get-NodeToolPaths -major $major

      # Log the resolved Node.js tooling information
      Write-Host "##[group]Node tooling (resolved)"
      & $tool.Node --version
      & $tool.Npm  --version
      & $tool.Npx  --version
      Write-Host "Resolved bin: $($tool.Bin)"
      Write-Host "##[endgroup]"

      # Add the resolved bin directory to the system PATH
      Write-Host "##vso[task.prependpath]$($tool.Bin)"
      $env:PATH = "$($tool.Bin);$env:PATH"

      # Expose the resolved paths as pipeline variables
      Write-Host "##vso[task.setvariable variable=SBOM_NODE_BIN]$($tool.Bin)"
      Write-Host "##vso[task.setvariable variable=SBOM_NODE]$($tool.Node)"
      Write-Host "##vso[task.setvariable variable=SBOM_NPM]$($tool.Npm)"
      Write-Host "##vso[task.setvariable variable=SBOM_NPX]$($tool.Npx)"
    displayName: "Setup Node.js tooling and expose paths"
