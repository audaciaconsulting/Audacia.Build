# Template: build project tags from environment variables (fail-closed when required)
parameters:
  - name: requireProjectTags
    type: boolean
    default: true  # if true, empty/invalid tags cause the step to fail

steps:
  # Step: Build project tags
  # - Uses PowerShell to construct a list of project tags based on environment variables
  # - Includes a mandatory tag for the environment (`env:$env:ENV_NAME`)
  # - Optionally includes additional tags from the `ADDITIONAL_TAGS` environment variable
  # - Deduplicates tags and converts them into a CSV format
  # - Sets the resulting CSV as an output variable `projectTagsCsv` for use in subsequent steps
  - task: PowerShell@2
    displayName: "Build project tags"
    name: buildTags
    inputs:
      pwsh: true
      targetType: inline
      script: |
        $ErrorActionPreference = 'Stop'
        $tags = New-Object System.Collections.Generic.List[string]

        # Mandatory env tag
        if (-not $env:ENV_NAME -or [string]::IsNullOrWhiteSpace($env:ENV_NAME)) {
          if ("${{ parameters.requireProjectTags }}" -eq "True") {
            throw "ENV_NAME not set; cannot build mandatory env:<ENV_NAME> tag."
          } else {
            Write-Warning "ENV_NAME not set; env tag will be omitted."
          }
        } else {
          $tags.Add("env:$env:ENV_NAME")
        }

        # Optional extras
        if ($env:ADDITIONAL_TAGS -and $env:ADDITIONAL_TAGS.Trim().Length -gt 0) {
          $extraTags = $env:ADDITIONAL_TAGS -split ',' | ForEach-Object { $_.Trim() } | Where-Object { $_ }
          foreach ($t in $extraTags) { $tags.Add($t) }
        }

        # Dedup & CSV
        $tagsCsv = ''
        if ($tags.Count -gt 0) {
          $seen=@{}; $deduped = $tags | Where-Object { if ($seen.ContainsKey($_)) {$false} else {$seen[$_]=$true; $true} }
          $tagsCsv = $deduped -join ','
        }

        if ("${{ parameters.requireProjectTags }}" -eq "True") {
          if ([string]::IsNullOrWhiteSpace($tagsCsv)) { throw "No project tags produced." }
          if (-not ($tagsCsv -split ',' | Where-Object { $_ -like 'env:*' })) {
            throw "Mandatory env:* tag missing."
          }
        } elseif ([string]::IsNullOrWhiteSpace($tagsCsv)) {
          Write-Warning "No project tags produced (requireProjectTags=false)."
        }

        Write-Host "Final projectTags CSV: '$tagsCsv'"
        Write-Host "##vso[task.setvariable variable=projectTagsCsv;isOutput=true]$tagsCsv"
