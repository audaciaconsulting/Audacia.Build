# Step: Create and publish a Markdown summary from uploaded rows
steps:
  - task: PowerShell@2
    displayName: "Upload summary"
    inputs:
      pwsh: true
      targetType: inline
      script: |
        $ErrorActionPreference='Stop'

        $rowsPath = Join-Path $env:AGENT_TEMPDIRECTORY 'dt-uploaded-rows.json'
        $rows = @()
        if (Test-Path -LiteralPath $rowsPath) {
          try { $rows = Get-Content -Raw -LiteralPath $rowsPath | ConvertFrom-Json } catch { $rows=@() }
        }

        # Normalize to array
        if ($rows -isnot [System.Collections.IEnumerable]) { $rows = @($rows) }
        if (-not $rows) { $rows = @() }

        $md = New-Object System.Collections.Generic.List[string]
        $md.Add("# Dependency-Track Upload Summary")
        $md.Add("")
        $md.Add("**Total Projects:** $($rows.Count)")
        $md.Add("")
        if ($rows.Count -gt 0) {
          $md.Add("| Project | Version |")
          $md.Add("|---|---|")
          foreach ($r in $rows) {
            $proj = [string]$r.Project
            $ver  = [string]$r.Version
            $md.Add("| $proj | $ver |")
          }
        } else {
          $md.Add("_No projects to list._")
        }

        $summary = Join-Path $env:AGENT_TEMPDIRECTORY "dt-upload-summary.md"
        Set-Content -LiteralPath $summary -Value ($md -join "`r`n") -Encoding UTF8
        Write-Host "##vso[task.uploadsummary]$summary"
