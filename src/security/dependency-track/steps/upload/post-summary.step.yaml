# Step: Create and publish a Markdown summary from uploaded rows
steps:
  - task: PowerShell@2
    displayName: "Upload summary"
    inputs:
      pwsh: true
      targetType: inline
      script: |
        $ErrorActionPreference='Stop'

        $rowsPath = Join-Path $env:AGENT_TEMPDIRECTORY 'dt-uploaded-rows.json'
        $rows = @()
        if (Test-Path -LiteralPath $rowsPath) {
          try { $rows = Get-Content -Raw -LiteralPath $rowsPath | ConvertFrom-Json } catch { $rows=@() }
        }

        $md = New-Object System.Collections.Generic.List[string]
        $md.Add("# Dependency-Track Upload Summary")
        $md.Add("")
        $md.Add("**Total Projects:** {0}" -f $rows.Count)
        $md.Add("")
        if ($rows.Count -gt 0) {
          $md.Add("| Project | Version |")
          $md.Add("|---|---|")
          foreach ($r in $rows) { $md.Add("| {0} | {1} |" -f $r.Project, $r.Version) }
        } else {
          $md.Add("_No projects to list._")
        }

        $summary = Join-Path $env:AGENT_TEMPDIRECTORY "dt-upload-summary.md"
        Set-Content -LiteralPath $summary -Value ($md -join "`r`n") -Encoding UTF8
        Write-Host "##vso[task.uploadsummary]$summary"
