# Step: Create and publish a Markdown summary from uploaded rows
steps:
  - task: PowerShell@2
    displayName: "Upload summary"
    inputs:
      pwsh: true
      targetType: inline
      script: |
        # Set strict error handling so the script fails on any error
        $ErrorActionPreference='Stop'

        # Path to the file containing the uploaded project rows (produced by previous step)
        $rowsPath = Join-Path $env:AGENT_TEMPDIRECTORY 'dt-uploaded-rows.json'
        $rows = @()
        # Attempt to read and parse the uploaded rows JSON file
        if (Test-Path -LiteralPath $rowsPath) {
          try { $rows = Get-Content -Raw -LiteralPath $rowsPath | ConvertFrom-Json } catch { $rows=@() }
        }
        # Ensure $rows is always an array for consistent processing
          if ($null -eq $rows) {
          $rows = @()
        } elseif ($rows -isnot [System.Collections.IEnumerable]) {
          $rows = @($rows)
        }
        
        # ---- Console output (grouped) ----
        # Output a summary group to the Azure DevOps log
        Write-Host "##[group]Dependency-Track Upload Summary (console)"
        Write-Host ("Total Projects: {0}" -f $rows.Count)
        if ($rows.Count -gt 0) {
          # Emit a compact table to STDOUT for unfamiliar readers following the live log
          "{0,-50} {1,-30}" -f "Project","Version" | Write-Host
          "{0,-50} {1,-30}" -f "-------","-------" | Write-Host
          foreach ($r in $rows) {
            "{0,-50} {1,-30}" -f ([string]$r.Project), ([string]$r.Version) | Write-Host
          }
        } else {
          Write-Host "_No projects to list._"
        }
        Write-Host "##[endgroup]"
