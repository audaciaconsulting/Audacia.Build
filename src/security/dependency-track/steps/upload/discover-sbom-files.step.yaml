# Template: discover SBOM JSON files and output as JSON array
steps:
  # Step: Discover SBOM files
  # - Uses PowerShell to locate SBOM JSON files in a specific directory
  # - Checks if the SBOM root directory exists; logs a warning and exits if not
  # - Searches recursively for `.json` files under the SBOM root directory
  # - Logs a warning and exits if no JSON files are found
  # - Converts the list of file paths to a JSON array
  # - Sets the JSON array as an output variable `sbomFilesJson` for use in subsequent steps
  - task: PowerShell@2
    displayName: "Discover SBOM files"
    name: discoverSboms
    inputs:
      pwsh: true
      targetType: inline
      script: |
        # Stop execution on errors
        $ErrorActionPreference = 'Stop'

        # Define the root directory for SBOM files
        $sbomRoot = "$(Agent.TempDirectory)/sbom"
        
        # Check if the SBOM root directory exists
        if (-not (Test-Path $sbomRoot)) {
          Write-Host "##vso[task.logissue type=warning]No SBOM directory at $sbomRoot"
          # Set an empty JSON array as the output variable
          Write-Host "##vso[task.setvariable variable=sbomFilesJson;isOutput=true][]"
          return
        }
        
        # Search for JSON files recursively under the SBOM root directory
        $files = Get-ChildItem -Path $sbomRoot -Recurse -Filter *.json -File
        if (-not $files) {
          Write-Host "##vso[task.logissue type=warning]No SBOM JSON files found under $sbomRoot"
          # Set an empty JSON array as the output variable
          Write-Host "##vso[task.setvariable variable=sbomFilesJson;isOutput=true][]"
          return
        }
        
        # Convert the list of file paths to a JSON array
        $filePaths = $files | ForEach-Object { $_.FullName }
        $filesJson = $filePaths | ConvertTo-Json -Compress

        Write-Host "Found $($files.Count) SBOM files"
        # Set the JSON array as an output variable for use in subsequent steps
        Write-Host "##vso[task.setvariable variable=sbomFilesJson;isOutput=true]$filesJson"
