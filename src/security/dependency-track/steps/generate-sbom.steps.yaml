# Template: generate SBOMs (npm + .NET), publish artifact if requested.
# Outputs:
#   - Sets pipeline variable `sbomExists` = true/false
#   - Publishes artifact if publishArtifact=true

parameters:
  - name: dotnetProjectsMultiline
    type: string
    default: ''
  - name: npmRootsMultiline
    type: string
    default: ''
  - name: publishArtifact
    type: boolean
    default: true
  - name: artifactName
    type: string
    default: 'sbom-files'
  - name: nodeVersion
    type: string
    default: '20.x'
  - name: includeLicenseTexts
    type: boolean
    default: true
  - name: requireAllExpectedSboms
    type: boolean
    default: true

steps:
  - task: NuGetAuthenticate@1
    displayName: "Authenticate to Azure Artifacts"

  # Consolidated: environment logging + npm manifest discovery
  - template: /src/security/dependency-track/steps/generate/log-env-and-discover-npm.step.yaml@templates
    parameters:
      npmRootsMultiline: ${{ parameters.npmRootsMultiline }}
      includeLicenseTexts: ${{ parameters.includeLicenseTexts }}
      requireAllExpectedSboms: ${{ parameters.requireAllExpectedSboms }}

  # Setup Node.js tooling
  - template: /src/security/dependency-track/steps/generate/setup-node.step.yaml@templates
    parameters:
      nodeVersion: ${{ parameters.nodeVersion }}

  # Setup CycloneDX .NET tool
  - template: /src/security/dependency-track/steps/generate/setup-cyclonedx-dotnet.step.yaml@templates

  # Resolve npm roots
  - template: /src/security/dependency-track/steps/generate/resolve-npm-roots.step.yaml@templates
    parameters:
      npmRootsMultiline: ${{ parameters.npmRootsMultiline }}

  # Resolve .NET projects
  - template: /src/security/dependency-track/steps/generate/resolve-dotnet-projects.step.yaml@templates
    parameters:
      dotnetProjectsMultiline: ${{ parameters.dotnetProjectsMultiline }}

  # Generate npm SBOMs
  - template: /src/security/dependency-track/steps/generate/generate-npm-sboms.step.yaml@templates
    parameters:
      includeLicenseTexts: ${{ parameters.includeLicenseTexts }}

  # Generate .NET SBOMs
  - template: /src/security/dependency-track/steps/generate/generate-dotnet-sboms.step.yaml@templates
    parameters:
      dotnetProjectsMultiline: ${{ parameters.dotnetProjectsMultiline }}

  # Validate that all expected SBOMs were generated (fail fast if not)
  - template: /src/security/dependency-track/steps/generate/validate-expected-sboms.step.yaml@templates
    parameters:
      strict: ${{ parameters.requireAllExpectedSboms }}
      dotnetProjectsMultiline: ${{ parameters.dotnetProjectsMultiline }}
      npmRootsMultiline: ${{ parameters.npmRootsMultiline }}

  # Publish SBOM artifact (conditional and fallback)
  - template: /src/security/dependency-track/steps/generate/publish-sbom-artifact.step.yaml@templates
    parameters:
      publishArtifact: ${{ parameters.publishArtifact }}
      artifactName: ${{ parameters.artifactName }}
