# Task to add a variable to the Terraform tfvars file
# This YAML script is used in an Azure DevOps pipeline to dynamically append a variable
# (name and value) to a Terraform tfvars file. It ensures Boolean values are properly
# written unquoted in lowercase, as required by Terraform.

parameters:
  # The directory where the Terraform tfvars file is located. Defaults to the pipeline's working directory.
  terraformDirectory: '$(System.DefaultWorkingDirectory)'

  # The name of the variable to be added to the tfvars file. This should not be empty.
  variableName: ''

  # The value of the variable to be added to the tfvars file. It can be a string, a number, or a Boolean.
  variableValue: ''
  
steps:
  - task: Powershell@2
    displayName: Set Terraform Variable '${{ parameters.variableName }}'
    inputs:
      targetType: inline
      script: |
        $name = "${{parameters.variableName}}"
        Write-Host "$name is ${{parameters.variableValue}} when passed in"
        
        
        # Validate that the variable name is not empty
        if ($name.Length -lt 1) {
          echo "Variable name is missing."
          exit 1
        }
        
        # Assign the variable value from the pipeline parameters
        $value = "${{parameters.variableValue}}"
        
        # Check if the value is Boolean (case-insensitively: true/false)
        if ($value -ieq "true" -or $value -ieq "false") {
            # Ensure Boolean is written in lowercase without quotes
            $normalizedValue = $value.ToLower()
            Add-Content ${{parameters.terraformDirectory}}/terraform.tfvars "`n`t$name = $normalizedValue"
        } else {
            # If the value is not a Boolean, treat it as a string and wrap it in quotes
            Add-Content ${{parameters.terraformDirectory}}/terraform.tfvars "`n`t$name = `"$value`"" 
        }
        
        Write-Host "This is the test pipeline 5"
        Write-Host "$name is $value"
        
        exit 0
